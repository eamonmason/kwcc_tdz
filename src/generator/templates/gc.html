{% extends "base.html" %}

{% block title %}GC Standings | KWCC Tour de Zwift 2026{% endblock %}

{% block extra_head %}
<style>
    .guest-indicator {
        display: inline-block;
        margin-left: 0.3rem;
        padding: 0.1rem 0.4rem;
        background: #6c757d;
        color: white;
        font-size: 0.7rem;
        border-radius: 3px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .guest-filter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .guest-filter input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .guest-filter label {
        cursor: pointer;
        user-select: none;
        margin: 0;
    }

    tr.guest-row.hidden {
        display: none;
    }

    .dns-row {
        background-color: #ffe5e5 !important;
        opacity: 0.8;
    }

    .stage-selector {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .stage-selector label {
        font-weight: 600;
        margin-right: 0.5rem;
    }

    .stage-selector select {
        padding: 0.5rem 1rem;
        font-size: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }

    .gc-standings-container {
        display: none;
    }

    .gc-standings-container.active {
        display: block;
    }

    .position-change {
        font-size: 0.75em;
        margin-left: 0.3rem;
        font-weight: normal;
    }

    .position-up {
        color: #28a745;
    }

    .position-down {
        color: #dc3545;
    }

    .stage-time a {
        color: inherit;
        text-decoration: none;
    }

    .stage-time a:hover {
        text-decoration: underline;
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="gc-header">
    <h2>General Classification</h2>
    <p class="gc-subtitle" id="gc-subtitle">
        {{ completed_stages }} of 6 stages completed
        {% if is_provisional %}
        <span class="provisional-badge">PROVISIONAL</span>
        {% endif %}
    </p>
</div>

<div class="stage-selector">
    <label for="stage-select">View GC after Stage:</label>
    <select id="stage-select">
        {% for stage_num in range(1, max_stage + 1) %}
        <option value="{{ stage_num }}" {% if stage_num == default_stage %}selected{% endif %}>
            Stage {{ stage_num }}
        </option>
        {% endfor %}
    </select>
</div>

<div class="guest-filter">
    <input type="checkbox" id="global-show-guests" checked>
    <label for="global-show-guests">Show guest riders</label>
</div>

{% for stage_num in range(1, max_stage + 1) %}
<div class="gc-standings-container" id="gc-stage-{{ stage_num }}" data-stage="{{ stage_num }}">
    <div class="gc-standings">
        <section class="group-gc" id="group-a-stage-{{ stage_num }}">
            <h3>Group A - GC</h3>
            {% set stage_gc_a = gc_by_stage_a[stage_num] %}
            {% if stage_gc_a.standings %}
            <div class="table-wrapper">
                <table class="results-table gc-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Rider</th>
                            <th>Handicap</th>
                            <th>Total Time</th>
                            <th>Gap</th>
                            {% for s in range(1, 7) %}
                            <th class="stage-col">S{{ s }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for standing in stage_gc_a.standings %}
                        <tr class="{% if standing.position <= 3 and not standing.is_dns %}top-three{% endif %}{% if standing.guest %} guest-row{% endif %}{% if standing.is_dns %} dns-row{% endif %}"
                            data-guest="{{ 'true' if standing.guest else 'false' }}"
                            data-rider-id="{{ standing.rider_id }}"
                            data-position="{{ standing.position }}">
                            <td class="position">
                                {% if standing.is_dns %}
                                DNS
                                {% elif standing.position == 1 %}
                                <span class="medal gold">&#129351;</span>
                                {% elif standing.position == 2 %}
                                <span class="medal silver">&#129352;</span>
                                {% elif standing.position == 3 %}
                                <span class="medal bronze">&#129353;</span>
                                {% else %}
                                {{ standing.position }}
                                {% endif %}
                            </td>
                            <td class="rider-name">
                                {{ standing.rider_name }}
                                {% if standing.guest %}
                                <span class="guest-indicator" title="Guest rider (non-club member)">Guest</span>
                                {% endif %}
                            </td>
                            <td class="handicap">{{ standing.handicap_group }}</td>
                            <td class="time total-time">{{ standing.total_time_display if not standing.is_dns else '-' }}</td>
                            <td class="gap">{{ standing.gap_display if not standing.is_dns else '-' }}</td>
                            {% for s in range(1, 7) %}
                            <td class="stage-time">{% set event_id = standing.stage_event_ids.get(s, '') %}{% if event_id %}<a href="https://zwiftpower.com/events.php?zid={{ event_id }}" target="_blank" title="View on ZwiftPower">{{ standing.get_stage_time_display(s) }}</a>{% else %}{{ standing.get_stage_time_display(s) }}{% endif %}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p class="results-count">
                {{ stage_gc_a.standings|length }} riders
                (after Stage {{ stage_num }})
            </p>
            {% else %}
            <p class="no-results">
                No riders have completed Stage {{ stage_num }} yet.
            </p>
            {% endif %}
        </section>

        <section class="group-gc" id="group-b-stage-{{ stage_num }}">
            <h3>Group B - GC</h3>
            {% set stage_gc_b = gc_by_stage_b[stage_num] %}
            {% if stage_gc_b.standings %}
            <div class="table-wrapper">
                <table class="results-table gc-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Rider</th>
                            <th>Handicap</th>
                            <th>Total Time</th>
                            <th>Gap</th>
                            {% for s in range(1, 7) %}
                            <th class="stage-col">S{{ s }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for standing in stage_gc_b.standings %}
                        <tr class="{% if standing.position <= 3 and not standing.is_dns %}top-three{% endif %}{% if standing.guest %} guest-row{% endif %}{% if standing.is_dns %} dns-row{% endif %}"
                            data-guest="{{ 'true' if standing.guest else 'false' }}"
                            data-rider-id="{{ standing.rider_id }}"
                            data-position="{{ standing.position }}">
                            <td class="position">
                                {% if standing.is_dns %}
                                DNS
                                {% elif standing.position == 1 %}
                                <span class="medal gold">&#129351;</span>
                                {% elif standing.position == 2 %}
                                <span class="medal silver">&#129352;</span>
                                {% elif standing.position == 3 %}
                                <span class="medal bronze">&#129353;</span>
                                {% else %}
                                {{ standing.position }}
                                {% endif %}
                            </td>
                            <td class="rider-name">
                                {{ standing.rider_name }}
                                {% if standing.guest %}
                                <span class="guest-indicator" title="Guest rider (non-club member)">Guest</span>
                                {% endif %}
                            </td>
                            <td class="handicap">{{ standing.handicap_group }}</td>
                            <td class="time total-time">{{ standing.total_time_display if not standing.is_dns else '-' }}</td>
                            <td class="gap">{{ standing.gap_display if not standing.is_dns else '-' }}</td>
                            {% for s in range(1, 7) %}
                            <td class="stage-time">{% set event_id = standing.stage_event_ids.get(s, '') %}{% if event_id %}<a href="https://zwiftpower.com/events.php?zid={{ event_id }}" target="_blank" title="View on ZwiftPower">{{ standing.get_stage_time_display(s) }}</a>{% else %}{{ standing.get_stage_time_display(s) }}{% endif %}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p class="results-count">
                {{ stage_gc_b.standings|length }} riders
                (after Stage {{ stage_num }})
            </p>
            {% else %}
            <p class="no-results">
                No riders have completed Stage {{ stage_num }} yet.
            </p>
            {% endif %}
        </section>

        <section class="group-gc" id="women-gc-stage-{{ stage_num }}">
            <h3>Women's GC</h3>
            {% set stage_gc_women = gc_by_stage_women[stage_num] %}
            {% if stage_gc_women.standings %}
            <table class="results-table gc-table women-gc-table" id="women-gc-table-{{ stage_num }}">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Rider</th>
                        <th>Handicap</th>
                        <th>Total Time</th>
                        <th>Gap</th>
                    </tr>
                </thead>
                <tbody>
                    {% for standing in stage_gc_women.standings %}
                    <tr class="{% if standing.position <= 3 %}top-three{% endif %}{% if standing.guest %} guest-row{% endif %}{% if standing.is_dns %} dns-row{% endif %}"
                        data-guest="{{ 'true' if standing.guest else 'false' }}">
                        <td class="position">
                            {% if not standing.is_dns %}
                                {% if standing.position == 1 %}
                                <span class="medal gold">&#129351;</span>
                                {% elif standing.position == 2 %}
                                <span class="medal silver">&#129352;</span>
                                {% elif standing.position == 3 %}
                                <span class="medal bronze">&#129353;</span>
                                {% else %}
                                {{ standing.position }}
                                {% endif %}
                            {% else %}
                                DNS
                            {% endif %}
                        </td>
                        <td class="rider-name">
                            {{ standing.rider_name }}
                            {% if standing.guest %}
                            <span class="guest-indicator">Guest</span>
                            {% endif %}
                        </td>
                        <td class="handicap">{{ standing.handicap_group }}</td>
                        <td class="time">{{ standing.total_time_display }}</td>
                        <td class="gap">
                            {% if not standing.is_dns %}
                                {{ standing.gap_display }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <p class="results-count">{{ stage_gc_women.standings|length }} riders in GC</p>
            {% else %}
            <p class="no-results">No women riders have completed all stages yet</p>
            {% endif %}
        </section>
    </div>
</div>
{% endfor %}

<section class="gc-rules">
    <h4>GC Rules</h4>
    <ul>
        <li>Riders must complete <strong>ALL</strong> stages to appear in GC standings</li>
        <li>Times are adjusted by adding handicap to raw finish time</li>
        <li>GC is the sum of adjusted times across all stages</li>
        <li>Results marked as PROVISIONAL may still change</li>
    </ul>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// Stage selection and GC display management
(function() {
    const stageSelect = document.getElementById('stage-select');
    const subtitle = document.getElementById('gc-subtitle');
    const currentStage = {{ current_stage }};
    const isStageInProgress = {{ 'true' if is_stage_in_progress else 'false' }};
    const maxStage = {{ max_stage }};

    if (!stageSelect) return;

    // Track current visible stage so guest filter can update position changes
    window.currentVisibleStage = parseInt(stageSelect.value);

    // Build position maps for each stage (rider_id -> position)
    function buildPositionMaps() {
        const maps = {};
        document.querySelectorAll('.gc-standings-container').forEach(container => {
            const stageNum = parseInt(container.dataset.stage);
            maps[stageNum] = {};

            // Get all rows with rider-id in this stage container (excluding Women's GC)
            container.querySelectorAll('.gc-table:not(.women-gc-table) tr[data-rider-id]').forEach(row => {
                const riderId = row.dataset.riderId;
                const position = parseInt(row.dataset.position);
                if (riderId && !isNaN(position) && position > 0) {
                    maps[stageNum][riderId] = position;
                }
            });
        });
        return maps;
    }

    const positionMaps = buildPositionMaps();

    // Update position change indicators for visible stage
    function updatePositionChanges(stageNum) {
        const currentContainer = document.getElementById(`gc-stage-${stageNum}`);
        if (!currentContainer) return;

        // Get position maps for current and previous stage
        const currentPositions = positionMaps[stageNum] || {};
        const prevPositions = stageNum > 1 ? (positionMaps[stageNum - 1] || {}) : {};

        // Update each row's position cell (excluding Women's GC)
        currentContainer.querySelectorAll('.gc-table:not(.women-gc-table) tr[data-rider-id]').forEach(row => {
            const riderId = row.dataset.riderId;
            const posCell = row.querySelector('.position');
            if (!posCell || row.classList.contains('dns-row')) return;

            // Remove any existing position change indicator
            const existingChange = posCell.querySelector('.position-change');
            if (existingChange) existingChange.remove();

            // Only show changes for Stage 2 onwards
            if (stageNum <= 1) return;

            const currentPos = currentPositions[riderId];
            const prevPos = prevPositions[riderId];

            // Only show if rider was in previous stage
            if (!prevPos || !currentPos) return;

            const change = prevPos - currentPos;
            if (change === 0) return; // No change

            const changeSpan = document.createElement('span');
            changeSpan.className = 'position-change';

            if (change > 0) {
                changeSpan.classList.add('position-up');
                changeSpan.innerHTML = `(&#8593;${change})`;
                changeSpan.title = `Up ${change} from Stage ${stageNum - 1}`;
            } else {
                changeSpan.classList.add('position-down');
                changeSpan.innerHTML = `(&#8595;${Math.abs(change)})`;
                changeSpan.title = `Down ${Math.abs(change)} from Stage ${stageNum - 1}`;
            }

            posCell.appendChild(changeSpan);
        });
    }

    // Expose updatePositionChanges globally so guest filter can use it
    window.updateGCPositionChanges = updatePositionChanges;

    // Show the selected stage's GC
    function showStageGC(stageNum) {
        // Hide all stage containers
        document.querySelectorAll('.gc-standings-container').forEach(container => {
            container.classList.remove('active');
        });

        // Show selected stage
        const selectedContainer = document.getElementById(`gc-stage-${stageNum}`);
        if (selectedContainer) {
            selectedContainer.classList.add('active');
        }

        // Update current visible stage
        window.currentVisibleStage = stageNum;

        // Update position change indicators
        updatePositionChanges(stageNum);

        // Update subtitle text
        updateSubtitle(stageNum);
    }

    // Update the subtitle based on selected stage
    function updateSubtitle(stageNum) {
        let text = '';
        if (stageNum === currentStage && isStageInProgress) {
            text = `${stageNum - 1} of ${maxStage} stages completed, Stage ${stageNum} in progress`;
        } else if (stageNum === maxStage && maxStage === 6) {
            text = `All 6 stages completed - Final Classification`;
        } else {
            text = `${stageNum} of ${maxStage} stages completed`;
        }

        // Add provisional badge if applicable
        {% if is_provisional %}
        text += ' <span class="provisional-badge">PROVISIONAL</span>';
        {% endif %}

        subtitle.innerHTML = text;
    }

    // Initialize with default stage
    showStageGC(parseInt(stageSelect.value));

    // Handle stage selection changes
    stageSelect.addEventListener('change', () => {
        const selectedStage = parseInt(stageSelect.value);
        showStageGC(selectedStage);
    });
})();

// Global guest rider filter with localStorage persistence
(function() {
    const STORAGE_KEY = 'kwcc-tdz-show-guests';
    const checkbox = document.getElementById('global-show-guests');

    if (!checkbox) return;

    // Load saved state from localStorage (default to true if not set)
    const savedState = localStorage.getItem(STORAGE_KEY);
    const showGuests = savedState === null ? true : savedState === 'true';
    checkbox.checked = showGuests;

    // Format time in seconds to display format
    function formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const mins = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        if (hours > 0) {
            return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Format gap to leader
    function formatGap(gapSeconds) {
        if (gapSeconds === 0) return '-';
        return '+' + formatTime(gapSeconds);
    }

    // Get medal HTML for position
    function getMedalHtml(position) {
        if (position === 1) return '<span class="medal gold">&#129351;</span>';
        if (position === 2) return '<span class="medal silver">&#129352;</span>';
        if (position === 3) return '<span class="medal bronze">&#129353;</span>';
        return position.toString();
    }

    // Recalculate positions within a table excluding hidden guest rows
    function recalculatePositions(table, showGuests) {
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        const rows = Array.from(tbody.querySelectorAll('tr'));
        let position = 1;
        let leaderTime = null;

        rows.forEach(row => {
            const isGuest = row.dataset.guest === 'true';
            const isDns = row.classList.contains('dns-row');
            const posCell = row.querySelector('.position');

            if (!showGuests && isGuest) {
                // Hide guest row
                row.classList.add('hidden');
                return;
            } else {
                row.classList.remove('hidden');
            }

            // Skip DNS rows for position calculation
            if (isDns) return;

            // Get total time from the cell (parse from display)
            const timeCell = row.querySelector('.total-time');
            if (!timeCell) return;

            // Update position
            if (posCell) {
                posCell.innerHTML = getMedalHtml(position);
                // Update top-three class
                if (position <= 3) {
                    row.classList.add('top-three');
                } else {
                    row.classList.remove('top-three');
                }
            }

            position++;
        });
    }

    // Apply guest filter and recalculate positions
    function applyGuestFilter(show) {
        // Get all GC tables except Women's GC (which shouldn't be filtered)
        const tables = document.querySelectorAll('.gc-table:not(.women-gc-table)');
        tables.forEach(table => {
            recalculatePositions(table, show);
        });

        // Re-apply position change indicators after recalculating positions
        if (window.updateGCPositionChanges && window.currentVisibleStage) {
            window.updateGCPositionChanges(window.currentVisibleStage);
        }
    }

    // Apply initial state
    applyGuestFilter(showGuests);

    // Listen for changes and persist to localStorage
    checkbox.addEventListener('change', () => {
        const show = checkbox.checked;
        localStorage.setItem(STORAGE_KEY, show.toString());
        applyGuestFilter(show);
    });
})();
</script>
{% endblock %}
