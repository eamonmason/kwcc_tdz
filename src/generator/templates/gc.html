{% extends "base.html" %}

{% block title %}GC Standings | KWCC Tour de Zwift 2026{% endblock %}

{% block extra_head %}
<style>
    .guest-indicator {
        display: inline-block;
        margin-left: 0.3rem;
        padding: 0.1rem 0.4rem;
        background: #6c757d;
        color: white;
        font-size: 0.7rem;
        border-radius: 3px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .guest-filter {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .guest-filter input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .guest-filter label {
        cursor: pointer;
        user-select: none;
        margin: 0;
    }

    tr.guest-row.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="gc-header">
    <h2>General Classification</h2>
    <p class="gc-subtitle">
        {{ completed_stages }} of 6 stages completed
        {% if is_provisional %}
        <span class="provisional-badge">PROVISIONAL</span>
        {% endif %}
    </p>
</div>

<div class="gc-standings">
    <section class="group-gc" id="group-a">
        <h3>Group A - GC</h3>
        {% if group_a.standings %}
        <div class="guest-filter">
            <input type="checkbox" id="show-guests-gc-a" checked>
            <label for="show-guests-gc-a">Show guest riders</label>
        </div>
        <div class="table-wrapper">
            <table class="results-table gc-table" id="table-gc-a">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Rider</th>
                        <th>Handicap</th>
                        <th>Total Time</th>
                        <th>Gap</th>
                        {% for stage_num in range(1, 7) %}
                        <th class="stage-col">S{{ stage_num }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for standing in group_a.standings %}
                    <tr class="{% if standing.position <= 3 %}top-three{% endif %}{% if standing.guest %} guest-row{% endif %}"
                        data-guest="{{ 'true' if standing.guest else 'false' }}">
                        <td class="position">
                            {% if standing.position == 1 %}
                            <span class="medal gold">&#129351;</span>
                            {% elif standing.position == 2 %}
                            <span class="medal silver">&#129352;</span>
                            {% elif standing.position == 3 %}
                            <span class="medal bronze">&#129353;</span>
                            {% else %}
                            {{ standing.position }}
                            {% endif %}
                        </td>
                        <td class="rider-name">
                            {{ standing.rider_name }}
                            {% if standing.guest %}
                            <span class="guest-indicator" title="Guest rider (non-club member)">Guest</span>
                            {% endif %}
                        </td>
                        <td class="handicap">{{ standing.handicap_group }}</td>
                        <td class="time total-time">{{ standing.total_time_display }}</td>
                        <td class="gap">{{ standing.gap_display }}</td>
                        {% for stage_num in range(1, 7) %}
                        <td class="stage-time">{{ standing.get_stage_time_display(stage_num) }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="results-count">
            {{ group_a.standings|length }} riders in GC
            (completed all {{ completed_stages }} stages)
        </p>
        {% else %}
        <p class="no-results">
            No riders have completed all stages yet.
            <br>
            Riders must complete ALL stages to appear in the GC standings.
        </p>
        {% endif %}
    </section>

    <section class="group-gc" id="group-b">
        <h3>Group B - GC</h3>
        {% if group_b.standings %}
        <div class="guest-filter">
            <input type="checkbox" id="show-guests-gc-b" checked>
            <label for="show-guests-gc-b">Show guest riders</label>
        </div>
        <div class="table-wrapper">
            <table class="results-table gc-table" id="table-gc-b">
                <thead>
                    <tr>
                        <th>Pos</th>
                        <th>Rider</th>
                        <th>Handicap</th>
                        <th>Total Time</th>
                        <th>Gap</th>
                        {% for stage_num in range(1, 7) %}
                        <th class="stage-col">S{{ stage_num }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for standing in group_b.standings %}
                    <tr class="{% if standing.position <= 3 %}top-three{% endif %}{% if standing.guest %} guest-row{% endif %}"
                        data-guest="{{ 'true' if standing.guest else 'false' }}">
                        <td class="position">
                            {% if standing.position == 1 %}
                            <span class="medal gold">&#129351;</span>
                            {% elif standing.position == 2 %}
                            <span class="medal silver">&#129352;</span>
                            {% elif standing.position == 3 %}
                            <span class="medal bronze">&#129353;</span>
                            {% else %}
                            {{ standing.position }}
                            {% endif %}
                        </td>
                        <td class="rider-name">
                            {{ standing.rider_name }}
                            {% if standing.guest %}
                            <span class="guest-indicator" title="Guest rider (non-club member)">Guest</span>
                            {% endif %}
                        </td>
                        <td class="handicap">{{ standing.handicap_group }}</td>
                        <td class="time total-time">{{ standing.total_time_display }}</td>
                        <td class="gap">{{ standing.gap_display }}</td>
                        {% for stage_num in range(1, 7) %}
                        <td class="stage-time">{{ standing.get_stage_time_display(stage_num) }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="results-count">
            {{ group_b.standings|length }} riders in GC
            (completed all {{ completed_stages }} stages)
        </p>
        {% else %}
        <p class="no-results">
            No riders have completed all stages yet.
            <br>
            Riders must complete ALL stages to appear in the GC standings.
        </p>
        {% endif %}
    </section>
</div>

<section class="gc-rules">
    <h4>GC Rules</h4>
    <ul>
        <li>Riders must complete <strong>ALL</strong> stages to appear in GC standings</li>
        <li>Times are adjusted by adding handicap to raw finish time</li>
        <li>GC is the sum of adjusted times across all stages</li>
        <li>Results marked as PROVISIONAL may still change</li>
    </ul>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// Guest rider filter functionality for GC
function setupGuestFilter(checkboxId, tableId) {
    const checkbox = document.getElementById(checkboxId);
    const table = document.getElementById(tableId);

    if (!checkbox || !table) return;

    checkbox.addEventListener('change', () => {
        const showGuests = checkbox.checked;
        const guestRows = table.querySelectorAll('tr[data-guest="true"]');

        guestRows.forEach(row => {
            if (showGuests) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
        });
    });
}

// Setup filters for both groups
setupGuestFilter('show-guests-gc-a', 'table-gc-a');
setupGuestFilter('show-guests-gc-b', 'table-gc-b');
</script>
{% endblock %}
