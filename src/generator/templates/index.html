{% extends "base.html" %}

{% block title %}KWCC Tour de Zwift 2026 - Home{% endblock %}

{% block extra_head %}
<style>
    .rider-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 0.5rem;
        vertical-align: middle;
        border: 2px solid #ddd;
    }

    .rider-name-with-avatar {
        display: flex;
        align-items: center;
    }

    .rider-avatar.loading-error {
        display: none;
    }

    .position-change {
        font-size: 0.75em;
        margin-left: 0.3rem;
        font-weight: normal;
    }

    .position-up {
        color: #28a745;
    }

    .position-down {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="hero">
    <h2>Tour de Zwift 2026</h2>
    <p class="tour-dates">January 5 - February 22, 2026</p>
    {% if is_stage_in_progress %}
    <div class="status-banner provisional">
        <span class="status-icon">&#9888;</span>
        Provisional Results - {% if active_stages|length > 1 %}Stages {% for s in active_stages %}{{ s.number }}{% if not loop.last %} &amp; {% endif %}{% endfor %}{% else %}Stage {{ current_stage }}{% endif %} in progress
    </div>
    {% elif is_provisional %}
    <div class="status-banner">
        <span class="status-icon">&#10003;</span>
        Stage {{ current_stage }} Complete{% if next_stage %} - Stage {{ next_stage.number }} starts {{ next_stage.start_date }}{% endif %}
    </div>
    {% else %}
    <div class="status-banner final">
        <span class="status-icon">&#10003;</span>
        Final Results
    </div>
    {% endif %}
</div>

<section class="stages-overview">
    <h3>Stage Overview</h3>
    <div class="stages-grid">
        {% for stage in stages %}
        <a href="stage_{{ stage.number }}.html" class="stage-card {% if stage.is_active %}active{% elif stage.is_complete %}complete{% else %}upcoming{% endif %}">
            <div class="stage-number">Stage {{ stage.number }}</div>
            <div class="stage-name">{{ stage.name }}</div>
            <div class="stage-route">{{ stage.display_route }}</div>
            <div class="stage-info">{{ stage.display_distance_km }}km | {{ stage.display_elevation_m }}m</div>
            {% if stage.is_active %}
            <span class="stage-status">IN PROGRESS</span>
            {% elif stage.is_complete %}
            <span class="stage-status">COMPLETE</span>
            {% else %}
            <span class="stage-status">{{ stage.start_date }}</span>
            {% endif %}
        </a>
        {% endfor %}
    </div>
</section>

<div class="gc-summary">
    <section class="group-standings">
        <h3>Group A - GC Standings</h3>
        {% if group_a.standings %}
        <table class="results-table">
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>Rider</th>
                    <th>Handicap</th>
                    <th>Total Time</th>
                    <th>Gap</th>
                </tr>
            </thead>
            <tbody>
                {% for standing in group_a.standings[:10] %}
                <tr class="{% if standing.position <= 3 %}top-three{% endif %}">
                    <td class="position">
                        {{ standing.position }}
                        {% if position_changes_a and standing.rider_id in position_changes_a %}
                            {% set prev_pos = position_changes_a[standing.rider_id] %}
                            {% set change = prev_pos - standing.position %}
                            {% if change > 0 %}
                                <span class="position-change position-up" title="Up {{ change }} from previous stage">(&#8593;{{ change }})</span>
                            {% elif change < 0 %}
                                <span class="position-change position-down" title="Down {{ change|abs }} from previous stage">(&#8595;{{ change|abs }})</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="rider-name">
                        <div class="rider-name-with-avatar">
                            <img src="{{ url_prefix }}avatars/{{ standing.rider_id }}.jpg"
                                 alt="{{ standing.rider_name }}"
                                 class="rider-avatar"
                                 onerror="this.classList.add('loading-error')">
                            <span>{{ standing.rider_name }}</span>
                        </div>
                    </td>
                    <td class="handicap">{{ standing.handicap_group }}</td>
                    <td class="time">{{ standing.total_time_display }}</td>
                    <td class="gap">{{ standing.gap_display }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if group_a.standings|length > 10 %}
        <p class="view-all"><a href="gc.html#group-a">View all {{ group_a.standings|length }} riders &rarr;</a></p>
        {% endif %}
        {% else %}
        <p class="no-results">No riders have completed all stages yet</p>
        {% endif %}
    </section>

    <section class="group-standings">
        <h3>Group B - GC Standings</h3>
        {% if group_b.standings %}
        <table class="results-table">
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>Rider</th>
                    <th>Handicap</th>
                    <th>Total Time</th>
                    <th>Gap</th>
                </tr>
            </thead>
            <tbody>
                {% for standing in group_b.standings[:10] %}
                <tr class="{% if standing.position <= 3 %}top-three{% endif %}">
                    <td class="position">
                        {{ standing.position }}
                        {% if position_changes_b and standing.rider_id in position_changes_b %}
                            {% set prev_pos = position_changes_b[standing.rider_id] %}
                            {% set change = prev_pos - standing.position %}
                            {% if change > 0 %}
                                <span class="position-change position-up" title="Up {{ change }} from previous stage">(&#8593;{{ change }})</span>
                            {% elif change < 0 %}
                                <span class="position-change position-down" title="Down {{ change|abs }} from previous stage">(&#8595;{{ change|abs }})</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="rider-name">
                        <div class="rider-name-with-avatar">
                            <img src="{{ url_prefix }}avatars/{{ standing.rider_id }}.jpg"
                                 alt="{{ standing.rider_name }}"
                                 class="rider-avatar"
                                 onerror="this.classList.add('loading-error')">
                            <span>{{ standing.rider_name }}</span>
                        </div>
                    </td>
                    <td class="handicap">{{ standing.handicap_group }}</td>
                    <td class="time">{{ standing.total_time_display }}</td>
                    <td class="gap">{{ standing.gap_display }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if group_b.standings|length > 10 %}
        <p class="view-all"><a href="gc.html#group-b">View all {{ group_b.standings|length }} riders &rarr;</a></p>
        {% endif %}
        {% else %}
        <p class="no-results">No riders have completed all stages yet</p>
        {% endif %}
    </section>

    <section class="group-standings">
        <h3>Women's GC</h3>
        {% if women_gc and women_gc.standings %}
        <table class="results-table">
            <thead>
                <tr>
                    <th>Pos</th>
                    <th>Rider</th>
                    <th>Handicap</th>
                    <th>Total Time</th>
                    <th>Gap</th>
                </tr>
            </thead>
            <tbody>
                {% for standing in women_gc.standings[:10] %}
                <tr class="{% if standing.position <= 3 %}top-three{% endif %}">
                    <td class="position">
                        {{ standing.position }}
                        {% if position_changes_women and standing.rider_id in position_changes_women %}
                            {% set prev_pos = position_changes_women[standing.rider_id] %}
                            {% set change = prev_pos - standing.position %}
                            {% if change > 0 %}
                                <span class="position-change position-up" title="Up {{ change }} from previous stage">(&#8593;{{ change }})</span>
                            {% elif change < 0 %}
                                <span class="position-change position-down" title="Down {{ change|abs }} from previous stage">(&#8595;{{ change|abs }})</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="rider-name">
                        <div class="rider-name-with-avatar">
                            <img src="{{ url_prefix }}avatars/{{ standing.rider_id }}.jpg"
                                 alt="{{ standing.rider_name }}"
                                 class="rider-avatar"
                                 onerror="this.classList.add('loading-error')">
                            <span>{{ standing.rider_name }}</span>
                        </div>
                    </td>
                    <td class="handicap">{{ standing.handicap_group }}</td>
                    <td class="time">{{ standing.total_time_display }}</td>
                    <td class="gap">{{ standing.gap_display }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if women_gc.standings|length > 10 %}
        <p class="view-all"><a href="gc.html#women-gc">View all {{ women_gc.standings|length }} riders &rarr;</a></p>
        {% endif %}
        {% else %}
        <p class="no-results">No women riders have completed all stages yet</p>
        {% endif %}
    </section>
</div>

<section class="handicap-info">
    <h3>Handicap System</h3>
    <div class="handicap-tables">
        <div class="handicap-group">
            <h4>Group A</h4>
            <table>
                <tr><td>A1 (Fastest)</td><td>+10 minutes</td></tr>
                <tr><td>A2</td><td>+5 minutes</td></tr>
                <tr><td>A3 (Scratch)</td><td>+0 minutes</td></tr>
            </table>
        </div>
        <div class="handicap-group">
            <h4>Group B</h4>
            <table>
                <tr><td>B1 (Fastest)</td><td>+15 minutes</td></tr>
                <tr><td>B2</td><td>+10 minutes</td></tr>
                <tr><td>B3</td><td>+4 minutes</td></tr>
                <tr><td>B4 (Scratch)</td><td>+0 minutes</td></tr>
            </table>
        </div>
    </div>
    <p class="handicap-note">
        <strong>GC Rule:</strong> Riders must complete ALL stages to appear in the GC standings.
    </p>
</section>
{% endblock %}
