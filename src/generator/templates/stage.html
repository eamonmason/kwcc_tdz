{% extends "base.html" %}

{% block title %}Stage {{ stage_number }} - {{ stage_name }} | KWCC TdZ 2026{% endblock %}

{% block extra_head %}
<style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background-color: rgba(0,0,0,0.05); }
    .sortable::after { content: ' ⇅'; opacity: 0.3; }
    .sortable.asc::after { content: ' ↑'; opacity: 1; }
    .sortable.desc::after { content: ' ↓'; opacity: 1; }
    .penalty-indicator { color: #dc3545; font-weight: bold; }
    .penalty-row { background-color: rgba(220, 53, 69, 0.05); }

    /* Course info styles */
    .course-info {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin: 1rem 0;
    }
    .course-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        flex: 1;
        min-width: 280px;
    }
    .course-card.multi-course {
        border-left: 4px solid #007bff;
    }
    .course-header {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .course-option {
        background: #007bff;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    .course-route {
        font-size: 1.1rem;
        font-weight: 600;
    }
    .course-stats {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
    }
    .course-stats span {
        margin-right: 1rem;
    }
    .course-links {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .course-link {
        display: inline-block;
        padding: 0.3rem 0.6rem;
        background: #e9ecef;
        border-radius: 4px;
        color: #007bff;
        text-decoration: none;
        font-size: 0.85rem;
    }
    .course-link:hover {
        background: #dee2e6;
        text-decoration: underline;
    }
    .course-penalties {
        font-size: 0.85rem;
        padding-top: 0.5rem;
        border-top: 1px solid #dee2e6;
    }
    .course-penalties ul {
        margin: 0.25rem 0 0 1.2rem;
        padding: 0;
    }
    .course-penalties li {
        color: #dc3545;
    }
    .course-penalties.no-penalties {
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="stage-header">
    <nav class="stage-nav">
        {% if stage_number > 1 %}
        <a href="stage_{{ stage_number - 1 }}.html" class="nav-prev">&larr; Stage {{ stage_number - 1 }}</a>
        {% endif %}
        {% if stage_number < 6 %}
        <a href="stage_{{ stage_number + 1 }}.html" class="nav-next">Stage {{ stage_number + 1 }} &rarr;</a>
        {% endif %}
    </nav>

    <h2>Stage {{ stage_number }}: {{ stage_name }}</h2>

    {% if courses and courses|length > 0 %}
    <div class="course-info">
        {% for course in courses %}
        <div class="course-card{% if courses|length > 1 %} multi-course{% endif %}">
            <div class="course-header">
                <span class="course-option">Option {{ course.option_letter }}</span>
                <span class="course-route">{{ course.route }}</span>
            </div>
            <div class="course-stats">
                <span class="distance">{{ course.distance_km }}km</span>
                <span class="elevation">{{ course.elevation_m }}m elevation</span>
            </div>
            <div class="course-links">
                {% if course.zwiftinsider_url %}
                <a href="{{ course.zwiftinsider_url }}" target="_blank" rel="noopener" class="course-link">
                    Route Info (Zwiftinsider)
                </a>
                {% endif %}
                {% if course.zwiftpower_search_url %}
                <a href="{{ course.zwiftpower_search_url }}" target="_blank" rel="noopener" class="course-link">
                    Upcoming Events (ZwiftPower)
                </a>
                {% endif %}
            </div>
            {% if course.has_penalties %}
            <div class="course-penalties">
                <strong>Penalty Events:</strong>
                <ul>
                    {% for penalty in course.penalty_events %}
                    <li>{{ penalty.description }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% else %}
            <div class="course-penalties no-penalties">
                <span>No time penalties for this course</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="stage-details">
        <span class="route">{{ route }}</span>
        <span class="distance">{{ distance_km }}km</span>
        <span class="elevation">{{ elevation_m }}m elevation</span>
    </div>
    {% endif %}

    {% if is_provisional %}
    <div class="status-banner provisional">
        <span class="status-icon">&#9888;</span>
        Provisional Results
    </div>
    {% endif %}
</div>

<div class="stage-results">
    <section class="group-results" id="group-a">
        <h3>Group A Results</h3>
        {% if group_a_results %}
        <div class="table-wrapper">
            <table class="results-table sortable-table" id="table-group-a">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="position" data-type="number">Pos</th>
                        <th class="sortable" data-sort="rider_name" data-type="string">Rider</th>
                        <th class="sortable" data-sort="handicap_group" data-type="string">Handicap</th>
                        <th class="sortable" data-sort="raw_time_seconds" data-type="number">Raw Time</th>
                        <th class="sortable" data-sort="handicap_seconds" data-type="number">Handicap Adj</th>
                        <th class="sortable" data-sort="penalty_seconds" data-type="number">Penalty</th>
                        <th class="sortable" data-sort="adjusted_time_seconds" data-type="number">Adjusted Time</th>
                        <th class="sortable" data-sort="gap_to_leader" data-type="number">Gap</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in group_a_results %}
                    <tr class="{% if result.position <= 3 %}top-three{% endif %}{% if result.has_penalty %} penalty-row{% endif %}"
                        data-position="{{ result.position }}"
                        data-rider_name="{{ result.rider_name }}"
                        data-handicap_group="{{ result.handicap_group }}"
                        data-raw_time_seconds="{{ result.raw_time_seconds }}"
                        data-handicap_seconds="{{ result.handicap_seconds }}"
                        data-penalty_seconds="{{ result.penalty_seconds }}"
                        data-adjusted_time_seconds="{{ result.adjusted_time_seconds }}"
                        data-gap_to_leader="{{ result.gap_to_leader }}">
                        <td class="position">
                            {% if result.position == 1 %}
                            <span class="medal gold">&#129351;</span>
                            {% elif result.position == 2 %}
                            <span class="medal silver">&#129352;</span>
                            {% elif result.position == 3 %}
                            <span class="medal bronze">&#129353;</span>
                            {% else %}
                            {{ result.position }}
                            {% endif %}
                        </td>
                        <td class="rider-name">
                            {{ result.rider_name }}
                            {% if result.has_penalty %}
                            <span class="penalty-indicator" title="{{ result.penalty_reason }}">*</span>
                            {% endif %}
                        </td>
                        <td class="handicap">{{ result.handicap_group }}</td>
                        <td class="time raw-time">
                            {% if result.event_id %}
                            <a href="https://zwiftpower.com/events.php?zid={{ result.event_id }}" target="_blank" title="View event on ZwiftPower">
                                {{ result.raw_time_display }}
                            </a>
                            {% else %}
                            {{ result.raw_time_display }}
                            {% endif %}
                        </td>
                        <td class="time handicap-adj">{{ result.handicap_display }}</td>
                        <td class="time penalty {% if result.has_penalty %}penalty-indicator{% endif %}">
                            {{ result.penalty_display }}
                            {% if result.penalty_reason %}
                            <span class="penalty-tooltip" title="{{ result.penalty_reason }}">&#9432;</span>
                            {% endif %}
                        </td>
                        <td class="time adjusted-time"><strong>{{ result.adjusted_time_display }}</strong></td>
                        <td class="gap">{{ result.gap_display }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="results-count">{{ group_a_results|length }} riders completed</p>
        {% else %}
        <p class="no-results">No results yet for Group A</p>
        {% endif %}
    </section>

    <section class="group-results" id="group-b">
        <h3>Group B Results</h3>
        {% if group_b_results %}
        <div class="table-wrapper">
            <table class="results-table sortable-table" id="table-group-b">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="position" data-type="number">Pos</th>
                        <th class="sortable" data-sort="rider_name" data-type="string">Rider</th>
                        <th class="sortable" data-sort="handicap_group" data-type="string">Handicap</th>
                        <th class="sortable" data-sort="raw_time_seconds" data-type="number">Raw Time</th>
                        <th class="sortable" data-sort="handicap_seconds" data-type="number">Handicap Adj</th>
                        <th class="sortable" data-sort="penalty_seconds" data-type="number">Penalty</th>
                        <th class="sortable" data-sort="adjusted_time_seconds" data-type="number">Adjusted Time</th>
                        <th class="sortable" data-sort="gap_to_leader" data-type="number">Gap</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in group_b_results %}
                    <tr class="{% if result.position <= 3 %}top-three{% endif %}{% if result.has_penalty %} penalty-row{% endif %}"
                        data-position="{{ result.position }}"
                        data-rider_name="{{ result.rider_name }}"
                        data-handicap_group="{{ result.handicap_group }}"
                        data-raw_time_seconds="{{ result.raw_time_seconds }}"
                        data-handicap_seconds="{{ result.handicap_seconds }}"
                        data-penalty_seconds="{{ result.penalty_seconds }}"
                        data-adjusted_time_seconds="{{ result.adjusted_time_seconds }}"
                        data-gap_to_leader="{{ result.gap_to_leader }}">
                        <td class="position">
                            {% if result.position == 1 %}
                            <span class="medal gold">&#129351;</span>
                            {% elif result.position == 2 %}
                            <span class="medal silver">&#129352;</span>
                            {% elif result.position == 3 %}
                            <span class="medal bronze">&#129353;</span>
                            {% else %}
                            {{ result.position }}
                            {% endif %}
                        </td>
                        <td class="rider-name">
                            {{ result.rider_name }}
                            {% if result.has_penalty %}
                            <span class="penalty-indicator" title="{{ result.penalty_reason }}">*</span>
                            {% endif %}
                        </td>
                        <td class="handicap">{{ result.handicap_group }}</td>
                        <td class="time raw-time">
                            {% if result.event_id %}
                            <a href="https://zwiftpower.com/events.php?zid={{ result.event_id }}" target="_blank" title="View event on ZwiftPower">
                                {{ result.raw_time_display }}
                            </a>
                            {% else %}
                            {{ result.raw_time_display }}
                            {% endif %}
                        </td>
                        <td class="time handicap-adj">{{ result.handicap_display }}</td>
                        <td class="time penalty {% if result.has_penalty %}penalty-indicator{% endif %}">
                            {{ result.penalty_display }}
                            {% if result.penalty_reason %}
                            <span class="penalty-tooltip" title="{{ result.penalty_reason }}">&#9432;</span>
                            {% endif %}
                        </td>
                        <td class="time adjusted-time"><strong>{{ result.adjusted_time_display }}</strong></td>
                        <td class="gap">{{ result.gap_display }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="results-count">{{ group_b_results|length }} riders completed</p>
        {% else %}
        <p class="no-results">No results yet for Group B</p>
        {% endif %}
    </section>
</div>

<section class="penalty-legend">
    <h4>Scoring Information</h4>
    <p>
        <strong>Adjusted Time</strong> = Raw Time + Handicap + Penalty
    </p>
    {% if has_penalty_events %}
    <p>
        <span class="penalty-indicator">*</span> indicates riders who rode a penalty event.
        See course details above for specific penalty times.
    </p>
    {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
<script>
// Sortable table functionality
document.querySelectorAll('.sortable-table').forEach(table => {
    const headers = table.querySelectorAll('th.sortable');

    headers.forEach(header => {
        header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            const sortType = header.dataset.type;
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Determine sort direction
            const isAsc = header.classList.contains('asc');

            // Clear all sort indicators
            headers.forEach(h => h.classList.remove('asc', 'desc'));

            // Set new sort direction
            header.classList.add(isAsc ? 'desc' : 'asc');

            // Sort rows
            rows.sort((a, b) => {
                let aVal = a.dataset[sortKey];
                let bVal = b.dataset[sortKey];

                if (sortType === 'number') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }

                if (aVal < bVal) return isAsc ? 1 : -1;
                if (aVal > bVal) return isAsc ? -1 : 1;
                return 0;
            });

            // Reorder DOM
            rows.forEach(row => tbody.appendChild(row));
        });
    });
});
</script>
{% endblock %}
